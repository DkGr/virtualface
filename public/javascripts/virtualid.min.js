/* VirtualID.js v0.0.24 */
function getCookie(e){return document.cookie.length>0&&(c_start=document.cookie.indexOf(e+"="),-1!=c_start)?(c_start=c_start+e.length+1,c_end=document.cookie.indexOf(";",c_start),-1==c_end&&(c_end=document.cookie.length),unescape(document.cookie.substring(c_start,c_end))):""}function prettyDate(e){d=new Date;var t=new Date((e||"").replace(/-/g,"/").replace(/[TZ]/g," ")),a=(d.getTime()-t.getTime())/1e3,n=Math.floor(a/86400);if(!(isNaN(n)||0>n))return 0==n&&(60>a&&"à l'instant"||120>a&&"il y a 1 minute"||3600>a&&"il y a "+Math.floor(a/60)+" minutes"||7200>a&&"il y a 1 heure"||86400>a&&"il y a "+Math.floor(a/3600)+" heures")||1==n&&"Hier"||7>n&&"il y a "+n+" jours"||n>=7&&"le "+d.getDate()+"/"+d.getMonth()+"/"+d.getFullYear()+" à "+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds()}function changeNewpostVisibility(){switch(newpostVisibility){case 0:$("#newpost-visibility-btn").html('<span class="glyphicon glyphicon-lock" aria-hidden="true"></span> Moi uniquement <span class="caret"></span>');break;case 1:$("#newpost-visibility-btn").html('<span class="glyphicon glyphicon-user" aria-hidden="true"></span> Amis <span class="caret"></span>');break;case 2:$("#newpost-visibility-btn").html('<span class="glyphicon glyphicon-globe" aria-hidden="true"></span> Public <span class="caret"></span>')}}function login(e,t){var a=$("#username").val(),n=$("#password").val();if(""!=a&&""!=n){var i="username="+a+"&password="+n;$.ajax({url:"webservice/login",type:"POST",data:i,processData:!1,success:function(e){var t=JSON.parse(e);return t.hasOwnProperty("error")?void $("#login-error").html(t.error):void(window.location="stream.php")}})}else{var i="username="+e+"&password="+t;$.ajax({url:"webservice/login",type:"POST",data:i,processData:!1,success:function(e){var t=JSON.parse(e);return t.hasOwnProperty("error")?void $("#login-error").html(t.error):void(window.location="stream.php")}})}}function loginfb(e){var t="fbuserid="+e;$.ajax({url:"webservice/loginfb",type:"POST",data:t,processData:!1,success:function(e){var t=JSON.parse(e);t.hasOwnProperty("error")?window.location="facebook-validation.php":window.location="stream.php"}})}function linktofb(e){var t="fbuserid="+e;$.ajax({url:"webservice/linktofb",type:"POST",data:t,processData:!1,success:function(e){var t=JSON.parse(e);t.hasOwnProperty("error")?$("#fblinked").html('Désactivé <a style="color:red;">('+t.error+")</a>"):$("#fblinked").html("Activé")}})}function unlinktofb(){var e="";$.ajax({url:"webservice/unlinktofb",type:"POST",data:e,processData:!1,success:function(e){location.reload()}})}function logout(){converse.user.logout(),"undefined"!=typeof FB&&connectedWithFacebook?FB.logout(function(e){$.ajax({type:"GET",url:"functions/logout.php",complete:function(e){window.location="index.php"}})}):$.ajax({type:"GET",url:"functions/logout.php",complete:function(e){window.location="index.php"}})}function setCookie(e,t,a){var n=new Date;n.setTime(n.getTime()+24*a*60*60*1e3);var i="expires="+n.toUTCString();document.cookie=e+"="+t+"; "+i}function getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),n=0;n<a.length;n++){for(var i=a[n];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}function subscribe(){var e=$("#sub-displayname").val(),t=$("#sub-username").val(),a=$("#sub-email").val(),n=$("#sub-password").val(),i=$("#sub-passwordcheck").val();if(n!=i)return void $("#errormessage").html("Les mots de passe ne correspondent pas.");if(""!=t&&""!=n&&""!=i){""==e&&(e=t),$("#subscribingModal").modal("show");var o={displayname:e,username:t,email:a,password:n};$.ajax({url:"webservice/users",type:"POST",contentType:"application/json",data:JSON.stringify(o),dataType:"json",processData:!1,success:function(e){var a=e;if(a.hasOwnProperty("error"))return $("#subscribingModal").modal("hide"),void $("#errormessage").html("Impossible de créer le compte :"+a.error);var i,o,s=window.location.host,r={numBits:2048,userIds:[{name:t,email:t+"@"+s}],passphrase:a.infos.password,unlocked:!1};openpgp.generateKey(r).then(function(e){i=e.privateKeyArmored,o=e.publicKeyArmored;var a={private_key:i,public_key:o};$.ajax({url:"webservice/users/savekeys",type:"POST",contentType:"application/json",data:JSON.stringify(a),dataType:"json",processData:!1,success:function(e){login(t,n)}})})["catch"](function(e){$("#subscribingModal").modal("hide"),$("#errormessage").html("Impossible de générer les clés de chiffrement.")})}})}}function subscribeFromFacebook(e,t){var a=$("#displayname").val(),n=$("#username").val(),i=$("#email").val(),o=$("#password").val(),s=$("#passcheck").val();if(o!=s)return void $("#errormessage").html("Les mots de passe ne correspondent pas.");if(""!=n&&""!=o&&""!=s){""==a&&(a=n),$("#subscribingModal").modal("show");var r={fbuserid:e,fbavatarurl:t,displayname:a,username:n,email:i,password:o};$.ajax({url:"webservice/fbusers",type:"POST",contentType:"application/json",data:JSON.stringify(r),dataType:"json",processData:!1,success:function(t){var a=t;if(a.hasOwnProperty("error"))return $("#subscribingModal").modal("hide"),void $("#errormessage").html("Impossible de créer le compte :"+a.error);var i,o,s=window.location.host,r={numBits:2048,userIds:[{name:n,email:n+"@"+s}],passphrase:a.infos.password,unlocked:!1};openpgp.generateKey(r).then(function(t){i=t.privateKeyArmored,o=t.publicKeyArmored;var a={private_key:i,public_key:o};$.ajax({url:"webservice/users/savekeys",type:"POST",contentType:"application/json",data:JSON.stringify(a),dataType:"json",processData:!1,success:function(t){loginfb(e)}})})["catch"](function(e){$("#subscribingModal").modal("hide"),$("#errormessage").html("Impossible de générer les clés de chiffrement.")})}})}}function IsJsonString(e){try{JSON.parse(e)}catch(t){return!1}return!0}function sendPost(){var e=$("#newpost-content").val();if(e){if(1==newpostVisibility)sendEncryptedPost(e);else{var t={visibility:newpostVisibility,content:e};$.ajax({url:"webservice/posts",type:"POST",contentType:"application/json",data:JSON.stringify(t),dataType:"json",processData:!1,success:function(){loadPosts()}})}$("#newpost-content").val(""),$("#postPreview").replaceWith("<div id=postPreview></div>")}}function sendComment(e,t,a,n){var i={postid:e,content:t};$.ajax({url:"webservice/comments",type:"POST",contentType:"application/json",data:JSON.stringify(i),dataType:"json",processData:!1,success:function(){refreshPageContent()}})}function sendEncryptedPost(e){$.ajax({async:!1,type:"GET",url:"webservice/users/current",complete:function(t){var a="",n=JSON.parse(t.responseText);a=n.public_key;var i=openpgp.key.readArmored(a);for(var o in n.friends)$.ajax({async:!1,type:"GET",url:"webservice/users/"+o,complete:function(e){var t=JSON.parse(e.responseText);a=t.public_key,i.keys.push(openpgp.key.readArmored(a).keys[0])}});console.log(i);var s;s={data:e,publicKeys:i.keys,armor:!0},openpgp.encrypt(s).then(function(e){var t={visibility:newpostVisibility,content:e.data};$.ajax({url:"webservice/posts",type:"POST",contentType:"application/json",data:JSON.stringify(t),dataType:"json",processData:!1,success:function(){loadPosts()}})})["catch"](function(e){console.log(e)})}})}function decryptMessage(e){!getCookie("vidcrypt");var t=e;return $.ajax({async:!1,type:"GET",url:"webservice/users/current",contentType:"application/json",dataType:"json",processData:!1,success:function(a){var n=a,i=openpgp.key.readArmored(n.private_key).keys[0],o=(i.decrypt(n.infos.password),openpgp.message.readArmored(e)),s=o.decrypt(i);t=s.getText()}}),t}function escapeSpecialChars(e){return e.replace(/([()[{*+.$^\\|?])/g,"\\$1")}function sendNewPostLike(e){var t={targetid:e,targettype:"post"};$.ajax({url:"webservice/likes",type:"POST",contentType:"application/json",data:JSON.stringify(t),dataType:"json",processData:!1,complete:function(){refreshPageContent()}})}function sendNewCommentLike(e){var t={targetid:e,targettype:"comment"};$.ajax({url:"webservice/likes",type:"POST",contentType:"application/json",data:JSON.stringify(t),dataType:"json",processData:!1,complete:function(){refreshPageContent()}})}function deleteLike(e){var t={likeid:e};$.ajax({type:"POST",url:"webservice/likes/delete",contentType:"application/json",data:JSON.stringify(t),dataType:"json",processData:!1,complete:function(){refreshPageContent()}})}function deleteComment(e){var t={id:e};$.ajax({type:"POST",url:"webservice/comments/delete",contentType:"application/json",data:JSON.stringify(t),dataType:"json",processData:!1,complete:function(){refreshPageContent()}})}function deletePost(e){var t={id:e};$.ajax({type:"POST",url:"webservice/posts/delete",contentType:"application/json",data:JSON.stringify(t),dataType:"json",processData:!1,success:function(){refreshPageContent()}})}function refreshIdentityPage(){var e=$("#identity-id").val();showIdentity(e)}function showIdentity(e){var t="identity.php?userid="+e,a=!0,n=document.createElement("FORM");n.method="GET",a&&(n.enctype="multipart/form-data"),n.style.display="none",document.body.appendChild(n),n.action=t.replace(/\?(.*)/,function(e,t){return t.replace(/\+/g," ").replace(/([^&=]+)=([^&=]*)/g,function(e,t,a){e=document.createElement("INPUT"),e.type="hidden",e.name=decodeURIComponent(t),e.value=decodeURIComponent(a),n.appendChild(e)}),""}),n.submit()}function loadPosts(){loadingPost=!0,$.ajax({type:"GET",url:"webservice/posts",complete:function(e){$("#posts-stream").hide();var t=JSON.parse(e.responseText),a="";t.forEach(function(e){var t=renderPost(e);a+=t}),0==a.length?($("#posts-stream").html("<p style=\"text-align:center;\">Il n'y a rien à afficher pour l'instant</p>"),endPostStream=!0):$("#posts-stream").html(a),$("#posts-stream").fadeIn(),$("#newcomment-content").keyup(function(){for(var e in emotmap){var t=new RegExp(escapeSpecialChars(e),"gim");this.value=this.value=this.value.replace(t,emotmap[e])}}),$(".button-send-newcomment").click(function(){var e=$(this).val(),t=$("#newcomment-content-"+e).val();return $("#newcomment-content").val(""),sendComment(e,t,null),!1}),$("#loadingAnimation").hide(),loadingPost=!1}})}function loadOlderPosts(){loadingPost=!0,$.ajax({type:"GET",url:"webservice/olderposts/"+lastPostId,complete:function(e){var t=JSON.parse(e.responseText),a="";t.forEach(function(e){var t=renderPost(e);a+=t}),0==a.length?($("#posts-stream").append('<p style="text-align:center;">Il n\'y a plus rien à afficher ici</p>'),endPostStream=!0):$("#posts-stream").append(a),$("#newcomment-content").keyup(function(){for(var e in emotmap){var t=new RegExp(escapeSpecialChars(e),"gim");this.value=this.value=this.value.replace(t,emotmap[e])}}),$(".button-send-newcomment").click(function(){var e=$(this).val(),t=$("#newcomment-content-"+e).val();return $("#newcomment-content").val(""),sendComment(e,t,null),!1}),$("#loadingAnimation").hide(),loadingPost=!1}})}function loadPost(){var e=$("#post-id").val();$.ajax({type:"GET",url:"webservice/posts/"+e,complete:function(e){$("#posts-stream").hide();var t,a="";if(""==e.responseText)a='<p style="text-align:center;">Erreur 404 : Contenu introuvable</p>';else{t=JSON.parse(e.responseText);var n=renderPost(t);a+=n}0==a.length?$("#posts-stream").html("<p style=\"text-align:center;\">Il n'y a rien à afficher pour l'instant</p>"):$("#posts-stream").html(a),$("#posts-stream").fadeIn(),$("#newcomment-content").keyup(function(){for(var e in emotmap){var t=new RegExp(escapeSpecialChars(e),"gim");this.value=this.value=this.value.replace(t,emotmap[e])}}),$(".button-send-newcomment").click(function(){var e=$(this).val(),t=$("#newcomment-content-"+e).val();return $("#newcomment-content").val(""),sendComment(e,t,null,!0),!1})}})}function loadIdentityPosts(e){$.ajax({type:"GET",url:"webservice/users/"+e+"/posts",complete:function(t){$("#posts-stream").hide();var a=JSON.parse(t.responseText),n="";a.forEach(function(e){var t=renderPost(e);n+=t}),0==n.length?$("#posts-stream").html("<p style=\"text-align:center;\">Il n'y a rien à afficher pour l'instant</p>"):$("#posts-stream").html(n),$("#posts-stream").fadeIn(),$("#newcomment-content").keyup(function(){for(var e in emotmap){var t=new RegExp(escapeSpecialChars(e),"gim");this.value=this.value=this.value.replace(t,emotmap[e])}}),$(".button-send-newcomment").click(function(){var t=$(this).val(),a=$("#newcomment-content-"+t).val();return $("#newcomment-content").val(""),sendComment(t,a,e),!1})}})}function loadPostComments(e){var t;return $.ajax({async:!1,type:"GET",url:"webservice/posts/"+e+"/comments",complete:function(e){t=JSON.parse(e.responseText)}}),t}function renderComment(e,t){var a;return $.ajax({async:!1,type:"GET",url:"webservice/users/"+e.author.$id,complete:function(n){var i=JSON.parse(n.responseText),o=prettyDate(e.date),s="";i.hasOwnProperty("private_key")&&(s='<!-- Split button --><div style="display:table-cell;vertical-align: top;" class="btn-group"><button style="padding: 0px 4px;float:right;" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span><span class="sr-only">Toggle Dropdown</span></button><ul style="top: 0;left: -165px;" class="dropdown-menu"><li><a href="#">Modifier</a></li><li><a href="javascript:void(0)" onclick="deleteComment(\''+e._id.$id+"');\">Supprimer</a></li></ul></div>");var r='style="border:none;background-color: rgba(53, 53, 53, 0.03);"';t&&(r='style="border:none;background-color: rgba(53, 53, 53, 0.01);"');var l,c=$("#myid").val(),p=0,d=!1,u="";$.ajax({async:!1,type:"GET",url:"webservice/comments/"+e._id.$id+"/likes",complete:function(e){l=JSON.parse(e.responseText)}}),l.forEach(function(e){p++,e.author.$id==c&&(d=!0,u=e._id.$id)});var m="";anonymous||(m='<a href="javascript:void(0)" onclick="sendNewCommentLike(\''+e._id.$id+"');\">J'aime</a>"),d&&(m='<a href="javascript:void(0)" onclick="deleteLike(\''+u+"');\">Je n'aime plus</a>");var f=i.infos.username;i.infos.hasOwnProperty("displayname")&&(f=i.infos.displayname);var y=new Date;a="<li "+r+' class="list-group-item"><div class="media"><div style="text-align:center;width: 12%;" class="media-left"><a href="identity.php?userid='+e.author.$id+'"><img class="media-object img-rounded" style="width: 32px; height: 32px; margin: auto;" src="avatars/'+e.author.$id+"?"+y.getTime()+'" alt="..."></a><a href="identity.php?userid='+e.author.$id+'">'+f+'</a></div><div class="media-body">'+findURL(e.content)+" </div>"+s+'<div style="float: left;margin: 10px 0 0 75px;">'+m+" - "+p+' <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> - <span class="p-date" style="font-size: 12px;color:grey;">Publié '+o+"</span></div></div></li>"}}),a}function refreshPageContent(){var e=location.pathname.substring(location.pathname.lastIndexOf("/")+1);"stream.php"===e?loadPosts():"identity.php"===e?loadIdentityPosts():"postview.php"===e&&loadPost()}function renderPost(e){var t;return $.ajax({async:!1,type:"GET",url:"webservice/users/"+e.author.$id,complete:function(a){var n=JSON.parse(a.responseText),i=prettyDate(e.date),o='<!-- Split button --><div style="display:table-cell;vertical-align: top;" class="btn-group"><button style="padding: 0px 4px;float:right;" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span><span class="sr-only">Toggle Dropdown</span></button><ul style="top: 0;left: -165px;" class="dropdown-menu"><li><a href="postview.php?postid='+e._id.$id+'">Lien de la publication</a></li></ul></div>';n.hasOwnProperty("private_key")&&(o='<!-- Split button --><div style="display:table-cell;vertical-align: top;" class="btn-group"><button style="padding: 0px 4px;float:right;" type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span><span class="sr-only">Toggle Dropdown</span></button><ul style="top: 0;left: -165px;" class="dropdown-menu"><li><a href="#">Modifier</a></li><li><a href="javascript:void(0)" onclick="deletePost(\''+e._id.$id+'\');">Supprimer</a></li><li><a href="postview.php?postid='+e._id.$id+'">Lien de la publication</a></li></ul></div>');var s,r=$("#myid").val(),l=0,c=!1,p="";$.ajax({async:!1,type:"GET",url:"webservice/posts/"+e._id.$id+"/likes",complete:function(e){s=JSON.parse(e.responseText)}}),s.forEach(function(e){l++,e.author.$id==r&&(c=!0,p=e._id.$id)});var d="";anonymous||(d='<a href="javascript:void(0)" onclick="sendNewPostLike(\''+e._id.$id+"');\">J'aime</a>"),c&&(d='<a href="javascript:void(0)" onclick="deleteLike(\''+p+"');\">Je n'aime plus</a>");var u=loadPostComments(e._id.$id),m="",f=!1,y=0;u.forEach(function(e){f=!f,m+=renderComment(e,f),y++});var v="";v='<ul class="list-group">',v+=m,v+="</ul>";var g="Aucuns commentaires";1==y?g="1 commentaire":y>1&&(g=y+" commentaires");var h=n.infos.username;n.infos.hasOwnProperty("displayname")&&(h=n.infos.displayname);var b="",w="",x="";switch(e.visibility){case 0:b='<span class="glyphicon glyphicon-lock" aria-hidden="true"></span> Moi uniquement',x='<div style="float: right;margin: 15px 0 0 75px;font-size:12px;color:grey;">Message crypté <span class="glyphicon glyphicon-lock" aria-hidden="true"></span></div>',w=decryptMessage(e.content);break;case 1:b='<span class="glyphicon glyphicon-user" aria-hidden="true"></span> Amis',x='<div style="float: right;margin: 15px 0 0 75px;font-size:12px;color:grey;">Message chiffré <span style="color: green;" class="glyphicon glyphicon-lock" aria-hidden="true"></span></div>',w=decryptMessage(e.content);break;case 2:b='<span class="glyphicon glyphicon-globe" aria-hidden="true"></span> Tout le monde'}""==w&&(w=e.content);var k=new Date;t='<div id="'+e._id.$id+'" style="box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.2);" class="panel panel-default"><div class="panel-body" style="border-radius: 5px;"><div class="media"><div style="text-align:center;" class="media-left"><a href="javascript:void(0)" onclick="showIdentity(\''+e.author.$id+'\');"><img class="media-object img-rounded" style="width: 64px; height: 64px;" src="avatars/'+e.author.$id+"?"+k.getTime()+'" alt="..."></a><a href="javascript:void(0)" onclick="showIdentity(\''+e.author.$id+"');\">"+h+'</a></div><div class="media-body">'+findURL(w)+" </div>"+o+'<div style="float: left;margin: 10px 0 0 75px;">'+l+' <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> - <span class="p-date" style="font-size: 12px;color:grey;">Publié '+i+'</span> - <span style="font-size: 12px;color:grey;">visibilité : '+b+"</span></div>"+x+'</div></div><div class="panel-footer" style="border-bottom-right-radius:5px;border-bottom-left-radius:5px;"><a role="button" data-toggle="collapse" href="#comments-scroll-'+e._id.$id+'" aria-expanded="false" aria-controls="comments-scroll-'+e._id.$id+'">'+g+"</a> - "+d+'</div><div class="collapse" id="comments-scroll-'+e._id.$id+'">'+v,anonymous||(t+='<div style="border: none; margin-bottom: 0px;box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.2);" class="panel panel-default"><textarea id="newcomment-content-'+e._id.$id+'" style="resize:vertical;border-radius:0px;" class="form-control" rows="3" placeholder="Inserez votre commentaire..."></textarea><div class="panel-footer" style="border-bottom-right-radius: 5px;border-bottom-left-radius: 5px;"><button style="font-weight: bold;font-size: 12px;" class="button-send-newcomment btn btn-info" value="'+e._id.$id+'" class="btn btn-info">Publier <span class="glyphicon glyphicon-send"></span></button></div></div>'),t+="</div></div>",lastPostId=e._id.$id}}),t}function addFriend(e){if(!friendRequestSent){var t=$("#identity-id").val(),a={userid:t};$.ajax({type:"POST",url:"webservice/friends/add",contentType:"application/json",data:JSON.stringify(a),dataType:"json",processData:!1,complete:function(){refreshIdentityPage()}})}friendRequestSent=!0}function updateNotifications(){$.ajax({type:"GET",url:"webservice/notifications",complete:function(e){var t='<div style="height:200px;overflow-y:scroll;border: 1px solid #DDD;">',a=0,n=!1,i="",o=JSON.parse(e.responseText);o.forEach(function(e){n=!0,t+=renderNotification(e),e.read||(a++,notifIdsUnread[a-1]=e._id.$id)}),n?(t+="</div>",a>0?(document.title="("+a+") VirtualID - Votre flux d'actualités",i='<a tabindex="0" class="btn" role="button" data-toggle="popover" style="width: 250px;" data-content="'+htmlEntities('<p style="text-align: center;"><a href="javascript:void(0)" onclick="setAllNotifRead();">Tout marquer comme lu</a></p>'+t)+'"><span class="glyphicon glyphicon-bell" aria-hidden="true"></span> Notifications <span class="badge">'+a+"</span></a>"):i='<a tabindex="0" class="btn" role="button" data-toggle="popover" style="width: 250px;" data-content="'+htmlEntities(t)+'"><span class="glyphicon glyphicon-bell" aria-hidden="true"></span> Notifications</a>'):(t="Il n'y a rien à afficher ici pour l'instant",i='<a tabindex="0" class="btn" role="button" data-toggle="popover" style="width: 250px;" data-content="'+t+'"><span class="glyphicon glyphicon-bell" aria-hidden="true"></span> Notifications</a>'),$("#notifPanel").html(i),$('[data-toggle="popover"]').popover({html:"true",placement:"bottom",trigger:"focus"})}})}function htmlEntities(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function renderNotification(e){var t=prettyDate(e.date);return e.read?'<div style="display: inline-block;width: 100%;" class="list-group-item"><div>'+e.content+'<p style="margin: 0px 0px 0px 0px;font-size: 12px;color:grey;">'+t+"</p></div></div>":'<div style="display: inline-block;width: 100%;margin-bottom: -6px;" class="list-group-item"><div style="width: 90%;float: left;">'+e.content+'<p style="margin: 0px 0px 0px 0px;font-size: 12px;color:grey;">'+t+'</p></div><div><a style="float:right;" href="javascript:void(0)" onclick="setNotifRead(\''+e._id.$id+'\')"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span></a></div></div>'}function setAllNotifRead(){notifIdsUnread.forEach(function(e){$.ajax({async:!1,type:"POST",url:"webservice/notifications/"+e,complete:function(e){}})}),updateNotifications()}function setNotifRead(e){$.ajax({type:"POST",url:"webservice/notifications/"+e,complete:function(e){updateNotifications()}})}function showMyFriendsPanel(){$.ajax({type:"GET",url:"webservice/users/current",complete:function(e){var t="",a=JSON.parse(e.responseText),n=a.friends,i=0;for(var o in n)$.ajax({async:!1,type:"GET",url:"webservice/users/"+o,complete:function(e){var a=JSON.parse(e.responseText),s=a.infos.username;a.infos.hasOwnProperty("displayname")&&(s=a.infos.displayname+" ("+a.infos.username+")"),n[o]&&i++;var r=new Date;t+='<div style="padding-right: 5px;padding-left: 5px;" class="col-lg-3 col-sm-4 col-xs-5"><a href="identity.php?userid='+o+'"><img data-toggle="tooltip" data-placement="top" data-original-title="'+s+'" style="margin-bottom: 0px;" src="avatars/'+o+"?"+r.getTime()+'" class="thumbnail img-responsive"></a></div>'}});0==i&&(t="<p style=\"margin: 15px 15px 10px;\">:( Vous n'avez pas encore d'amis...</p>"),$("#my-user-panel").html(t),$('[data-toggle="tooltip"]').tooltip()}})}function showHisFriendsPanel(e){$.ajax({type:"GET",url:"webservice/users/"+e,complete:function(e){var t="",a=JSON.parse(e.responseText),n=a.friends;console.log(n);var i=0;for(var o in n)$.ajax({async:!1,type:"GET",url:"webservice/users/"+o,complete:function(e){var a=JSON.parse(e.responseText),s=a.infos.username;a.infos.hasOwnProperty("displayname")&&(s=a.infos.displayname+" ("+a.infos.username+")"),n[o]&&i++;var r=new Date;t+='<div style="padding-right: 5px;padding-left: 5px;" class="col-lg-3 col-sm-4 col-xs-5"><a href="identity.php?userid='+o+'"><img data-toggle="tooltip" data-placement="top" data-original-title="'+s+'" style="margin-bottom: 0px;" src="avatars/'+o+"?"+r.getTime()+'" class="thumbnail img-responsive"></a></div>'}});0==i&&(t='<p style="margin: 15px 15px 10px;">:( Aucun ami à afficher...</p>'),$("#his-user-panel").html(t),$('[data-toggle="tooltip"]').tooltip()}})}function loadIdentity(){var e=$("#identity-id").val();$.ajax({type:"GET",url:"webservice/users/"+e,complete:function(t){var a=JSON.parse(t.responseText);$("#identity-avatar").attr("src",function(){var t=new Date;return"avatars/"+e+"?"+t.getTime()});var n=a.infos.username;a.infos.hasOwnProperty("displayname")&&(n=a.infos.displayname+" ("+a.infos.username+")"),$("#identity-name").text(n),document.title="VirtualID - Profil de "+n,a.hasOwnProperty("private_key")?$("#identity-actions").remove():anonymous||$.ajax({type:"GET",url:"webservice/friends/status/"+e,complete:function(e){var t=JSON.parse(e.responseText);"asked"==t.friendStatus?$("#identity-actions").prepend('<span class="label label-info">Demande d\'ami envoyée</span><br/>'):"acceptation"==t.friendStatus?($("#identity-actions").prepend('<span class="label label-warning">Attends votre acceptation</span><br/>'),$("#identity-actions-buttons").append('<button onclick="addFriend(true);" class="btn btn-default" type="button"><span class="glyphicon glyphicon-ok-circle" aria-hidden="true"></span> Accepter</button>')):"friend"==t.friendStatus?$("#identity-actions").prepend('<span class="label label-success">Ami</span><br/>'):$("#identity-actions-buttons").append('<button onclick="addFriend(false);" class="btn btn-default" type="button"><span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span> Ajouter</button>')}})}}),loadIdentityPosts(e),showHisFriendsPanel(e)}function loadAccountSettings(){$.ajax({type:"GET",url:"webservice/users/current",complete:function(e){var t=JSON.parse(e.responseText);linkedToFacebook=t["fb-link"],linkedToFacebook&&$("#revocateFBDiv").html('<a href="javascript: void(0);" data-placement="right" data-toggle="popover" title="Qu\'est ce que c\'est ?" data-content="En cliquant sur ce bouton vous allez supprimer la possibilité de vous connecter à VirtualID avec votre compte Facebook."><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span></a> <button id="revocateFB" type="button" class="btn btn-danger">Révoquer le lien Facebook</button>');var a='<label class="btn btn-primary"><input type="radio" name="options" id="option3" autocomplete="off" checked> Moi uniquement</label>',n='<label class="btn btn-primary"><input type="radio" name="options" id="option2" autocomplete="off" checked> Mes amis</label>',i='<label class="btn btn-primary"><input type="radio" name="options" id="option1" autocomplete="off" checked> Tout le monde</label>';switch(t.privacy_settings.email){case 0:a='<label class="btn btn-primary active"><input type="radio" name="options" id="option3" autocomplete="off" checked> Moi uniquement</label>';break;case 1:n='<label class="btn btn-primary active"><input type="radio" name="options" id="option2" autocomplete="off" checked> Mes amis</label>';break;case 2:i='<label class="btn btn-primary active"><input type="radio" name="options" id="option1" autocomplete="off" checked> Tout le monde</label>'}switch($("#emailPrivacySettings").html(i+n+a),a='<label class="btn btn-primary"><input type="radio" name="options" id="option3" autocomplete="off" checked> Moi uniquement</label>',n='<label class="btn btn-primary"><input type="radio" name="options" id="option2" autocomplete="off" checked> Mes amis</label>',i='<label class="btn btn-primary"><input type="radio" name="options" id="option1" autocomplete="off" checked> Tout le monde</label>',t.privacy_settings.friends){case 0:a='<label class="btn btn-primary active"><input type="radio" name="options" id="option3" autocomplete="off" checked> Moi uniquement</label>';break;case 1:n='<label class="btn btn-primary active"><input type="radio" name="options" id="option2" autocomplete="off" checked> Mes amis</label>';break;case 2:i='<label class="btn btn-primary active"><input type="radio" name="options" id="option1" autocomplete="off" checked> Tout le monde</label>'}switch($("#friendsPrivacySettings").html(i+n+a),a='<label class="btn btn-primary"><input type="radio" name="options" id="option3" autocomplete="off" checked> Moi uniquement</label>',n='<label class="btn btn-primary"><input type="radio" name="options" id="option2" autocomplete="off" checked> Mes amis</label>',i='<label class="btn btn-primary"><input type="radio" name="options" id="option1" autocomplete="off" checked> Tout le monde</label>',t.privacy_settings.displayname){case 0:a='<label class="btn btn-primary active"><input type="radio" name="options" id="option3" autocomplete="off" checked> Moi uniquement</label>';break;case 1:n='<label class="btn btn-primary active"><input type="radio" name="options" id="option2" autocomplete="off" checked> Mes amis</label>';break;case 2:i='<label class="btn btn-primary active"><input type="radio" name="options" id="option1" autocomplete="off" checked> Tout le monde</label>'}$("#displaynamePrivacySettings").html(i+n+a),$("#username").text(t.infos.username),$("#displayname").val(t.infos.displayname),$("#email").val(t.infos.email),$("#publicKey").val(t.public_key),linkedToFacebook?$("#fblinked").html("Activé"):$("#fblinked").html("Désactivé")}})}function saveInfosSettings(){var e=$("#displayname").val(),t=$("#email").val(),a={displayname:e,email:t};$.ajax({url:"webservice/users/update",type:"POST",contentType:"application/json",data:JSON.stringify(a),dataType:"json",processData:!1,success:function(e){loadAcountSettings(),$("#saveAccountInfosBtn").html('Valider <span style="color: green;" class="glyphicon glyphicon-ok" aria-hidden="true"></span>')}})}function findURL(e){var t=__urlRegex,a="://www.youtube.com/watch",n="://www.dailymotion.com/video/";return e.replace(t,function(t){if(__imgRegex.lastIndex=0,__imgRegex.test(t))return'<br/><div style="margin-top: 15px;"><img src="'+t+'" width="250" /></div>';if(e.includes(a)){var i=e.search(a),o=e.substring(a.length+i+3,e.length);return'<br/><div style="margin-top: 15px;"><iframe width="560" height="315" src="//www.youtube.com/embed/'+o+'" frameborder="0" allowfullscreen></iframe></div>'}if(e.includes(n)){var i=e.search(n),o=e.substring(i+n.length,i+n.length+7);return'<br/><div style="margin-top: 15px;"><iframe frameborder="0" width="480" height="270" src="//www.dailymotion.com/embed/video/'+o+'" allowfullscreen></iframe></div>'}var s="test";return $.ajax({async:!1,type:"GET",url:"webservice/extracturl",data:"url="+t,complete:function(e){var a=JSON.parse(e.responseText),n=a.desc,i=a.title;s='<div style="margin:20px;" class="panel panel-default"><div style="font-weight: bold;" class="panel-heading"><a href="'+t+'">'+i+'</a></div><div class="panel-body">'+n+'</div><div class="panel-footer"><img alt="favicon" src="https://www.google.com/s2/favicons?domain='+t+'"> <a href="'+t+'">'+extractDomain(t)+"</a></div></div>"}}),s})}function extractDomain(e){var t;return t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0],t=t.split(":")[0]}function showLoadingAnimation(e,t){var a=1-e,n=0,i=a;drawArrowBody(n*pi,i*pi,t),drawTriangle(i*pi),n=i+e,i=n+a,drawArrowBody(n*pi,i*pi,t),drawTriangle(i*pi)}function drawArrowBody(e,t,a){var n=!1;context.beginPath(),context.arc(x,y,radius,e,t,n),context.lineWidth=a,context.strokeStyle=colorBody,context.stroke(),context.closePath()}function drawTriangle(e){var t=x+radius*Math.cos(e),a=y+radius*Math.sin(e);context.beginPath(),context.moveTo(t,a);var n=t+triangleSide/2*Math.cos(e),i=a+triangleSide/2*Math.sin(e);context.lineTo(n,i);var o=t+Math.sqrt(3)/2*triangleSide*Math.sin(-e),s=a+Math.sqrt(3)/2*triangleSide*Math.cos(-e);context.lineTo(o,s);var r=t-triangleSide/2*Math.cos(e),l=a-triangleSide/2*Math.sin(e);context.lineTo(r,l),context.lineTo(t,a),context.lineWidth=arrowStrength,context.strokeStyle=colorTriangle,context.stroke(),context.closePath()}var emotmap={"<3":"❤️","</3":"💔",":D":"😁",":)":"😃",xD:"😆","^^'":"😅",";)":"😉",":(":"😞",":p":"😛",";p":"😜",":'(":"😢"},newpostVisibility=1,notifIdsUnread=[],friendRequestSent=!1,lastPostId,endPostStream=!1,loadingPost=!1,createCookie=function(e,t,a){var n;if(a){var i=new Date;i.setTime(i.getTime()+24*a*60*60*1e3),n="; expires="+i.toGMTString()}else n="";
document.cookie=e+"="+t+n+"; path=/"},radius=50,arrowStrength=18,triangleSide=20,distanceArrows=.3,colorBody="#313131",colorTriangle="#000000",pi=Math.PI;$(document).ready(function(){friendRequestSent=!1,$("#validate-sub").click(function(){subscribe()}),$("#login-btn").click(function(){login(null,null)}),$("#saveAccountInfosBtn").click(function(){saveInfosSettings()}),$("#newpost-content").keyup(function(){for(var e in emotmap){var t=new RegExp(escapeSpecialChars(e),"gim");this.value=this.value=this.value.replace(t,emotmap[e])}this.value?$("#postPreview").replaceWith('<div style="border: 1px solid #ccc;border-radius: 4px;padding: 6px 12px;" id=postPreview><h5 style="color: #D8D8D8;font-weight: bold;font-style: italic;">Prévisualisation de votre message</h5>'+findURL(this.value)+"</div>"):$("#postPreview").replaceWith("<div id=postPreview></div>")}),$("#newpost-visibility-public-btn").click(function(){return newpostVisibility=2,changeNewpostVisibility(),$("#newpost-visibility-btn").dropdown("toggle"),!1}),$("#newpost-visibility-friend-btn").click(function(){return newpostVisibility=1,changeNewpostVisibility(),$("#newpost-visibility-btn").dropdown("toggle"),!1}),$("#button-send-newpost").click(function(){return sendPost(),!1}),$("#notifRead").click(function(){return setNotifRead(),!1}),$("#username").change(function(){$("#username").val($("#username").val().toLowerCase())}),$("#sub-username").change(function(){$("#sub-username").val($("#sub-username").val().toLowerCase())})});var __urlRegex=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,__imgRegex=/\.(?:jpe?g|gif|png)$/i;
